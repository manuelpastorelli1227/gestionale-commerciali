<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CommercialeApp - Gestione Rete Vendita HACCP</title>
    <style>
        :root {
            /* Primitive Color Tokens */
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-teal-800: rgba(41, 150, 161, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);

            /* RGB versions for opacity control */
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;
            --color-orange-500-rgb: 168, 75, 47;
            --color-orange-400-rgb: 230, 129, 97;

            /* Background color tokens */
            --color-bg-1: rgba(59, 130, 246, 0.08);
            --color-bg-2: rgba(245, 158, 11, 0.08);
            --color-bg-3: rgba(34, 197, 94, 0.08);
            --color-bg-4: rgba(239, 68, 68, 0.08);
            --color-bg-5: rgba(147, 51, 234, 0.08);
            --color-bg-6: rgba(249, 115, 22, 0.08);
            --color-bg-7: rgba(236, 72, 153, 0.08);
            --color-bg-8: rgba(6, 182, 212, 0.08);

            /* Semantic Color Tokens */
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);
            --color-warning: var(--color-orange-500);
            --color-info: var(--color-slate-500);
            --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);

            /* Typography */
            --font-family-base: "Arial", sans-serif;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --font-size-4xl: 30px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 550;
            --font-weight-bold: 600;
            --line-height-tight: 1.2;
            --line-height-normal: 1.5;

            /* Spacing */
            --space-4: 4px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;

            /* Border Radius */
            --radius-sm: 6px;
            --radius-base: 8px;
            --radius-md: 10px;
            --radius-lg: 12px;
            --radius-full: 9999px;

            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);

            /* Custom colors for business app */
            --app-primary: #1e40af;
            --app-primary-light: #3b82f6;
            --app-primary-dark: #1e3a8a;
            --app-success: #059669;
            --app-warning: #d97706;
            --app-danger: #dc2626;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-base);
            background-color: #f8fafc;
            color: var(--color-text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-16);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--app-primary) 0%, var(--app-primary-dark) 100%);
            color: white;
            padding: var(--space-16) 0;
            box-shadow: var(--shadow-md);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-16);
        }

        .logo {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
        }

        .user-info {
            font-size: var(--font-size-sm);
            opacity: 0.9;
        }

        /* Navigation */
        .nav {
            background: white;
            border-bottom: 1px solid var(--color-border);
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-tabs {
            display: flex;
            overflow-x: auto;
            background: white;
        }

        .nav-tab {
            flex: none;
            padding: var(--space-16) var(--space-20);
            border: none;
            background: none;
            color: var(--color-text-secondary);
            font-size: var(--font-size-base);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background-color: var(--color-bg-1);
            color: var(--color-text);
        }

        .nav-tab.active {
            color: var(--app-primary);
            border-bottom-color: var(--app-primary);
            background-color: var(--color-bg-1);
        }

        /* Content */
        .content {
            padding: var(--space-24) 0;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Dashboard Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-20);
            margin-bottom: var(--space-32);
        }

        .stat-card {
            background: white;
            padding: var(--space-24);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-card-border);
        }

        .stat-value {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--app-primary);
            margin-bottom: var(--space-8);
        }

        .stat-label {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        /* Map Container */
        .map-container {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-card-border);
            height: 400px;
            position: relative;
        }

        .map {
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #e6f7ff 0%, #f0f8ff 100%);
            position: relative;
            overflow: hidden;
        }

        .map-pin {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            transform: translate(-50%, -50%);
            z-index: 10;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .map-pin.da_visitare { background: var(--app-danger); }
        .map-pin.visitato { background: var(--app-success); }
        .map-pin.follow_up { background: var(--app-warning); }

        .map-tooltip {
            position: absolute;
            background: white;
            padding: var(--space-8) var(--space-12);
            border-radius: var(--radius-base);
            box-shadow: var(--shadow-md);
            font-size: var(--font-size-sm);
            z-index: 20;
            display: none;
            max-width: 200px;
        }

        /* Shop List */
        .shop-filters {
            display: flex;
            gap: var(--space-16);
            margin-bottom: var(--space-24);
            flex-wrap: wrap;
        }

        .filter-input, .filter-select {
            padding: var(--space-8) var(--space-12);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
        }

        .filter-input {
            flex: 1;
            min-width: 200px;
        }

        .shop-list {
            display: grid;
            gap: var(--space-16);
        }

        .shop-card {
            background: white;
            padding: var(--space-20);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-card-border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .shop-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .shop-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-12);
        }

        .shop-name {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
        }

        .shop-status {
            padding: var(--space-4) var(--space-8);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            text-transform: uppercase;
        }

        .shop-status.da_visitare {
            background: rgba(220, 38, 38, 0.1);
            color: var(--app-danger);
        }

        .shop-status.visitato {
            background: rgba(5, 150, 105, 0.1);
            color: var(--app-success);
        }

        .shop-status.follow_up {
            background: rgba(217, 119, 6, 0.1);
            color: var(--app-warning);
        }

        .shop-details {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: var(--space-16);
            margin-top: var(--space-12);
        }

        .shop-info {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        .interest-rating {
            display: flex;
            gap: 2px;
        }

        .star {
            color: #fbbf24;
            font-size: var(--font-size-sm);
        }

        .star.empty {
            color: #d1d5db;
        }

        /* Buttons */
        .btn {
            padding: var(--space-8) var(--space-16);
            border: none;
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: var(--space-8);
        }

        .btn-primary {
            background: var(--app-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--app-primary-dark);
        }

        .btn-secondary {
            background: var(--color-secondary);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover {
            background: var(--color-secondary-hover);
        }

        .btn-success {
            background: var(--app-success);
            color: white;
        }

        .btn-sm {
            padding: var(--space-4) var(--space-8);
            font-size: var(--font-size-sm);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: var(--space-20);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: var(--space-32);
            border-radius: var(--radius-lg);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-24);
        }

        .modal-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: var(--font-size-xl);
            cursor: pointer;
            color: var(--color-text-secondary);
            padding: var(--space-4);
        }

        /* Form */
        .form-group {
            margin-bottom: var(--space-20);
        }

        .form-label {
            display: block;
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--space-8);
            color: var(--color-text);
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: var(--space-8) var(--space-12);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-family: inherit;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Interest Slider */
        .interest-slider-container {
            margin: var(--space-16) 0;
        }

        .interest-slider {
            width: 100%;
            margin: var(--space-8) 0;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .slider-value {
            text-align: center;
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--app-primary);
            margin-top: var(--space-8);
        }

        /* Statistics */
        .chart-container {
            background: white;
            padding: var(--space-24);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-24);
        }

        .chart-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-16);
            color: var(--color-text);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .nav-tabs {
                justify-content: flex-start;
            }

            .shop-header {
                flex-direction: column;
                gap: var(--space-8);
            }

            .shop-details {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: var(--space-16);
                padding: var(--space-20);
            }
        }

        /* Visit History */
        .visit-history {
            margin-top: var(--space-24);
        }

        .visit-item {
            background: #f8f9fa;
            padding: var(--space-16);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-12);
            border-left: 4px solid var(--app-primary);
        }

        .visit-date {
            font-weight: var(--font-weight-semibold);
            color: var(--app-primary);
            margin-bottom: var(--space-8);
        }

        .visit-rating {
            margin-bottom: var(--space-8);
        }

        .visit-comment {
            color: var(--color-text-secondary);
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">üéØ CommercialeApp HACCP</div>
                <div class="user-info">
                    <div>üëã Buongiorno, Mario Rossi</div>
                    <div>üìÖ Mercoled√¨, 15 Ottobre 2025</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <div class="container">
            <div class="nav-tabs">
                <button class="nav-tab active" data-section="dashboard">üìä Dashboard</button>
                <button class="nav-tab" data-section="mappa">üó∫Ô∏è Mappa</button>
                <button class="nav-tab" data-section="negozi">üè™ Lista Negozi</button>
                <button class="nav-tab" data-section="statistiche">üìà Statistiche</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="content">
        <div class="container">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">3</div>
                        <div class="stat-label">Visite Oggi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">12</div>
                        <div class="stat-label">Visite Settimana</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">6.2</div>
                        <div class="stat-label">Interesse Medio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">25%</div>
                        <div class="stat-label">Tasso Conversione</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">4</div>
                        <div class="stat-label">Follow-up Necessari</div>
                    </div>
                </div>

                <div class="map-container">
                    <div class="map" id="dashboardMap">
                        <!-- Map pins will be added by JavaScript -->
                        <div class="map-tooltip" id="mapTooltip"></div>
                    </div>
                </div>
            </section>

            <!-- Mappa Section -->
            <section id="mappa" class="section">
                <div style="margin-bottom: 20px;">
                    <h2 style="margin-bottom: 16px;">üó∫Ô∏è Mappa Negozi Milano</h2>
                    <div class="shop-filters">
                        <select class="filter-select" id="mapFilter">
                            <option value="tutti">Tutti i negozi</option>
                            <option value="da_visitare">Da visitare</option>
                            <option value="visitato">Visitati</option>
                            <option value="follow_up">Follow-up</option>
                        </select>
                        <select class="filter-select" id="typeFilter">
                            <option value="tutti">Tutti i tipi</option>
                            <option value="Ristorante">Ristoranti</option>
                            <option value="Bar">Bar</option>
                            <option value="Alimentari">Alimentari</option>
                            <option value="Panetteria">Panetterie</option>
                        </select>
                    </div>
                </div>
                
                <div class="map-container" style="height: 500px;">
                    <div class="map" id="mainMap">
                        <div class="map-tooltip" id="mainMapTooltip"></div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 20px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="map-pin da_visitare" style="position: relative; transform: none;"></div>
                        <span>Da visitare</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="map-pin visitato" style="position: relative; transform: none;"></div>
                        <span>Visitato</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="map-pin follow_up" style="position: relative; transform: none;"></div>
                        <span>Follow-up</span>
                    </div>
                </div>
            </section>

            <!-- Negozi Section -->
            <section id="negozi" class="section">
                <div style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                    <h2>üè™ Lista Negozi</h2>
                    <button class="btn btn-primary" onclick="openAddShopModal()">‚ûï Aggiungi Negozio</button>
                </div>
                
                <div class="shop-filters">
                    <input type="text" class="filter-input" id="searchInput" placeholder="üîç Cerca negozi...">
                    <select class="filter-select" id="statusFilter">
                        <option value="tutti">Tutti gli stati</option>
                        <option value="da_visitare">Da visitare</option>
                        <option value="visitato">Visitati</option>
                        <option value="follow_up">Follow-up</option>
                    </select>
                    <select class="filter-select" id="shopTypeFilter">
                        <option value="tutti">Tutti i tipi</option>
                        <option value="Ristorante">Ristoranti</option>
                        <option value="Bar">Bar</option>
                        <option value="Alimentari">Alimentari</option>
                        <option value="Panetteria">Panetterie</option>
                    </select>
                </div>

                <div class="shop-list" id="shopList">
                    <!-- Shop cards will be added by JavaScript -->
                </div>
            </section>

            <!-- Statistiche Section -->
            <section id="statistiche" class="section">
                <h2 style="margin-bottom: 24px;">üìà Statistiche</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">23</div>
                        <div class="stat-label">Totale Negozi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">15</div>
                        <div class="stat-label">Negozi Visitati</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">65%</div>
                        <div class="stat-label">Copertura Territorio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">‚Ç¨3.240</div>
                        <div class="stat-label">Fatturato Potenziale</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">üìä Andamento Visite Settimanali</h3>
                    <canvas id="visitsChart" width="400" height="200"></canvas>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">üéØ Distribuzione per Tipo Attivit√†</h3>
                    <canvas id="typeChart" width="400" height="200"></canvas>
                </div>
            </section>
        </div>
    </main>

    <!-- Shop Detail Modal -->
    <div class="modal" id="shopModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="shopModalTitle">Dettagli Negozio</h3>
                <button class="close-btn" onclick="closeShopModal()">&times;</button>
            </div>
            <div id="shopModalContent">
                <!-- Content will be filled by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Visit Registration Modal -->
    <div class="modal" id="visitModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üìù Registra Visita</h3>
                <button class="close-btn" onclick="closeVisitModal()">&times;</button>
            </div>
            <form id="visitForm">
                <input type="hidden" id="visitShopId">
                
                <div class="form-group">
                    <label class="form-label">Data e Ora</label>
                    <input type="datetime-local" class="form-input" id="visitDateTime" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Grado di Interesse (0-10)</label>
                    <div class="interest-slider-container">
                        <input type="range" class="interest-slider" id="interestSlider" min="0" max="10" value="5">
                        <div class="slider-labels">
                            <span>0 - Per niente</span>
                            <span>10 - Molto interessato</span>
                        </div>
                        <div class="slider-value" id="sliderValue">5</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Risultato Visita</label>
                    <select class="form-select" id="visitResult" required>
                        <option value="">Seleziona risultato</option>
                        <option value="interessato">Interessato</option>
                        <option value="non_interessato">Non interessato</option>
                        <option value="da_ricontattare">Da ricontattare</option>
                        <option value="preventivo_richiesto">Preventivo richiesto</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Note e Commenti</label>
                    <textarea class="form-textarea" id="visitComments" placeholder="Aggiungi note sulla visita..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Prossima Azione</label>
                    <select class="form-select" id="nextAction">
                        <option value="">Nessuna azione</option>
                        <option value="richiamata">Richiamata telefonica</option>
                        <option value="email_info">Invio email informativa</option>
                        <option value="preventivo">Preparare preventivo</option>
                        <option value="demo">Organizzare demo</option>
                    </select>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">üíæ Salva Visita</button>
                    <button type="button" class="btn btn-secondary" onclick="closeVisitModal()">‚ùå Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Shop Modal -->
    <div class="modal" id="addShopModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚ûï Aggiungi Nuovo Negozio</h3>
                <button class="close-btn" onclick="closeAddShopModal()">&times;</button>
            </div>
            <form id="addShopForm">
                <div class="form-group">
                    <label class="form-label">Nome Attivit√† *</label>
                    <input type="text" class="form-input" id="newShopName" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Indirizzo *</label>
                    <input type="text" class="form-input" id="newShopAddress" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Tipo Attivit√† *</label>
                    <select class="form-select" id="newShopType" required>
                        <option value="">Seleziona tipo</option>
                        <option value="Ristorante">Ristorante</option>
                        <option value="Bar">Bar</option>
                        <option value="Alimentari">Alimentari</option>
                        <option value="Panetteria">Panetteria</option>
                        <option value="Pizzeria">Pizzeria</option>
                        <option value="Gastronomia">Gastronomia</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Note</label>
                    <textarea class="form-textarea" id="newShopNotes" placeholder="Note aggiuntive..."></textarea>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">‚úÖ Aggiungi Negozio</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddShopModal()">‚ùå Annulla</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Sample data - in a real app this would come from a database
        let negozi = [
            {
                id: 1,
                nome: "Ristorante Da Mario",
                indirizzo: "Via Roma 15, Milano",
                tipo: "Ristorante",
                stato: "da_visitare",
                interesse: 0,
                ultimo_contatto: "",
                lat: 45.4642,
                lng: 9.1900,
                visite: []
            },
            {
                id: 2,
                nome: "Bar Centrale",
                indirizzo: "Piazza Duomo 8, Milano",
                tipo: "Bar",
                stato: "visitato",
                interesse: 8,
                ultimo_contatto: "2025-10-14",
                lat: 45.4641,
                lng: 9.1895,
                visite: [
                    {
                        data: "2025-10-14T10:30",
                        interesse: 8,
                        risultato: "interessato",
                        commenti: "Molto interessato ai corsi HACCP, ricontattare entro una settimana",
                        prossima_azione: "preventivo"
                    }
                ]
            },
            {
                id: 3,
                nome: "Alimentari Rossi",
                indirizzo: "Via Garibaldi 22, Milano",
                tipo: "Alimentari",
                stato: "visitato",
                interesse: 3,
                ultimo_contatto: "2025-10-13",
                lat: 45.4648,
                lng: 9.1885,
                visite: [
                    {
                        data: "2025-10-13T15:20",
                        interesse: 3,
                        risultato: "non_interessato",
                        commenti: "Hanno gi√† un consulente, non interessati al momento",
                        prossima_azione: ""
                    }
                ]
            },
            {
                id: 4,
                nome: "Trattoria Bella Vista",
                indirizzo: "Corso Buenos Aires 45, Milano",
                tipo: "Ristorante",
                stato: "follow_up",
                interesse: 7,
                ultimo_contatto: "2025-10-12",
                lat: 45.4738,
                lng: 9.2034,
                visite: [
                    {
                        data: "2025-10-12T11:45",
                        interesse: 7,
                        risultato: "preventivo_richiesto",
                        commenti: "Interessati ma vogliono preventivo dettagliato",
                        prossima_azione: "preventivo"
                    }
                ]
            },
            {
                id: 5,
                nome: "Panetteria Moderna",
                indirizzo: "Via Torino 18, Milano",
                tipo: "Panetteria",
                stato: "da_visitare",
                interesse: 0,
                ultimo_contatto: "",
                lat: 45.4601,
                lng: 9.1821,
                visite: []
            }
        ];

        let servizi = [
            { nome: "Corso HACCP Base", prezzo: "‚Ç¨120", durata: "4 ore" },
            { nome: "Corso HACCP Avanzato", prezzo: "‚Ç¨180", durata: "8 ore" },
            { nome: "Redazione Manuale HACCP", prezzo: "‚Ç¨350", servizio: "una tantum" },
            { nome: "Redazione DVR", prezzo: "‚Ç¨500", servizio: "una tantum" }
        ];

        // Current state
        let currentSection = 'dashboard';
        let filteredNegozi = [...negozi];

        // Navigation handling
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        function initApp() {
            setupNavigation();
            setupFilters();
            renderDashboard();
            renderMaps();
            renderShopList();
            renderStatistics();
            setupForms();
        }

        function setupNavigation() {
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const sectionName = this.dataset.section;
                    showSection(sectionName);
                });
            });
        }

        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName).classList.add('active');
            
            // Add active class to selected tab
            document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');
            
            currentSection = sectionName;
            
            // Re-render maps when switching to map sections
            if (sectionName === 'dashboard' || sectionName === 'mappa') {
                setTimeout(renderMaps, 100);
            }
        }

        function renderDashboard() {
            // Dashboard stats are already in HTML, maps will be rendered separately
        }

        function renderMaps() {
            renderMap('dashboardMap', 'mapTooltip');
            renderMap('mainMap', 'mainMapTooltip');
        }

        function renderMap(mapId, tooltipId) {
            const mapContainer = document.getElementById(mapId);
            const tooltip = document.getElementById(tooltipId);
            
            if (!mapContainer) return;
            
            // Clear existing pins
            mapContainer.querySelectorAll('.map-pin').forEach(pin => pin.remove());
            
            // Add background pattern to simulate map
            if (!mapContainer.style.backgroundImage) {
                mapContainer.style.background = `
                    linear-gradient(45deg, #e6f7ff 25%, transparent 25%), 
                    linear-gradient(-45deg, #e6f7ff 25%, transparent 25%), 
                    linear-gradient(45deg, transparent 75%, #e6f7ff 75%), 
                    linear-gradient(-45deg, transparent 75%, #e6f7ff 75%)
                `;
                mapContainer.style.backgroundSize = '20px 20px';
                mapContainer.style.backgroundPosition = '0 0, 0 10px, 10px -10px, -10px 0px';
            }
            
            negozi.forEach((negozio, index) => {
                const pin = document.createElement('div');
                pin.className = `map-pin ${negozio.stato}`;
                
                // Convert lat/lng to pixel coordinates (simplified)
                const x = ((negozio.lng - 9.18) / 0.04) * mapContainer.offsetWidth;
                const y = ((45.48 - negozio.lat) / 0.04) * mapContainer.offsetHeight;
                
                pin.style.left = Math.max(20, Math.min(mapContainer.offsetWidth - 20, x)) + 'px';
                pin.style.top = Math.max(20, Math.min(mapContainer.offsetHeight - 20, y)) + 'px';
                
                pin.addEventListener('mouseenter', function(e) {
                    tooltip.innerHTML = `
                        <strong>${negozio.nome}</strong><br>
                        üìç ${negozio.indirizzo}<br>
                        üè™ ${negozio.tipo}<br>
                        ${negozio.interesse > 0 ? `‚≠ê Interesse: ${negozio.interesse}/10` : '‚ùì Non ancora visitato'}
                    `;
                    tooltip.style.display = 'block';
                    tooltip.style.left = (e.pageX - mapContainer.getBoundingClientRect().left + 10) + 'px';
                    tooltip.style.top = (e.pageY - mapContainer.getBoundingClientRect().top - 10) + 'px';
                });
                
                pin.addEventListener('mouseleave', function() {
                    tooltip.style.display = 'none';
                });
                
                pin.addEventListener('click', function() {
                    openShopModal(negozio.id);
                });
                
                mapContainer.appendChild(pin);
            });
        }

        function setupFilters() {
            // Search filter
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', applyFilters);
            }
            
            // Status filter
            const statusFilter = document.getElementById('statusFilter');
            if (statusFilter) {
                statusFilter.addEventListener('change', applyFilters);
            }
            
            // Type filter
            const shopTypeFilter = document.getElementById('shopTypeFilter');
            if (shopTypeFilter) {
                shopTypeFilter.addEventListener('change', applyFilters);
            }
            
            // Map filters
            const mapFilter = document.getElementById('mapFilter');
            if (mapFilter) {
                mapFilter.addEventListener('change', applyFilters);
            }
            
            const typeFilter = document.getElementById('typeFilter');
            if (typeFilter) {
                typeFilter.addEventListener('change', applyFilters);
            }
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('statusFilter')?.value || 'tutti';
            const typeFilter = document.getElementById('shopTypeFilter')?.value || 'tutti';
            
            filteredNegozi = negozi.filter(negozio => {
                const matchSearch = negozio.nome.toLowerCase().includes(searchTerm) || 
                                   negozio.indirizzo.toLowerCase().includes(searchTerm);
                const matchStatus = statusFilter === 'tutti' || negozio.stato === statusFilter;
                const matchType = typeFilter === 'tutti' || negozio.tipo === typeFilter;
                
                return matchSearch && matchStatus && matchType;
            });
            
            renderShopList();
        }

        function renderShopList() {
            const shopList = document.getElementById('shopList');
            if (!shopList) return;
            
            shopList.innerHTML = '';
            
            filteredNegozi.forEach(negozio => {
                const shopCard = document.createElement('div');
                shopCard.className = 'shop-card';
                shopCard.onclick = () => openShopModal(negozio.id);
                
                const starsHtml = generateStarsHTML(negozio.interesse);
                const statusText = {
                    'da_visitare': 'Da Visitare',
                    'visitato': 'Visitato',
                    'follow_up': 'Follow-up'
                }[negozio.stato];
                
                shopCard.innerHTML = `
                    <div class="shop-header">
                        <h3 class="shop-name">${negozio.nome}</h3>
                        <span class="shop-status ${negozio.stato}">${statusText}</span>
                    </div>
                    <div class="shop-details">
                        <div class="shop-info">
                            <div>üìç ${negozio.indirizzo}</div>
                            <div>üè™ ${negozio.tipo}</div>
                            ${negozio.ultimo_contatto ? `<div>üìÖ Ultimo contatto: ${formatDate(negozio.ultimo_contatto)}</div>` : ''}
                        </div>
                        <div class="interest-rating">
                            ${starsHtml}
                        </div>
                    </div>
                `;
                
                shopList.appendChild(shopCard);
            });
        }

        function generateStarsHTML(rating) {
            let html = '';
            for (let i = 1; i <= 10; i++) {
                html += `<span class="star ${i <= rating ? '' : 'empty'}">‚òÖ</span>`;
            }
            return html;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT');
        }

        function formatDateTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString('it-IT');
        }

        function openShopModal(shopId) {
            const negozio = negozi.find(n => n.id === shopId);
            if (!negozio) return;
            
            const modal = document.getElementById('shopModal');
            const title = document.getElementById('shopModalTitle');
            const content = document.getElementById('shopModalContent');
            
            title.textContent = negozio.nome;
            
            const starsHtml = generateStarsHTML(negozio.interesse);
            
            let visiteHtml = '';
            if (negozio.visite && negozio.visite.length > 0) {
                visiteHtml = `
                    <div class="visit-history">
                        <h4 style="margin-bottom: 16px;">üìã Storico Visite</h4>
                        ${negozio.visite.map(visita => `
                            <div class="visit-item">
                                <div class="visit-date">üìÖ ${formatDateTime(visita.data)}</div>
                                <div class="visit-rating">‚≠ê Interesse: ${visita.interesse}/10</div>
                                <div>üìä Risultato: ${getResultText(visita.risultato)}</div>
                                ${visita.commenti ? `<div class="visit-comment">üí¨ ${visita.commenti}</div>` : ''}
                                ${visita.prossima_azione ? `<div>üéØ Prossima azione: ${getActionText(visita.prossima_azione)}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            content.innerHTML = `
                <div style="margin-bottom: 24px;">
                    <p><strong>üìç Indirizzo:</strong> ${negozio.indirizzo}</p>
                    <p><strong>üè™ Tipo:</strong> ${negozio.tipo}</p>
                    <p><strong>üìä Stato:</strong> ${getStatusText(negozio.stato)}</p>
                    ${negozio.ultimo_contatto ? `<p><strong>üìÖ Ultimo contatto:</strong> ${formatDate(negozio.ultimo_contatto)}</p>` : ''}
                    <div style="margin: 12px 0;">
                        <strong>‚≠ê Interesse:</strong>
                        <div style="margin-top: 4px;">${starsHtml}</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="openVisitModal(${negozio.id})">
                        üìù Registra Visita
                    </button>
                    <button class="btn btn-secondary" onclick="simulateNavigation('${negozio.nome}', '${negozio.indirizzo}')">
                        üß≠ Naviga
                    </button>
                </div>
                
                ${visiteHtml}
            `;
            
            modal.classList.add('active');
        }

        function closeShopModal() {
            document.getElementById('shopModal').classList.remove('active');
        }

        function getStatusText(stato) {
            const statusMap = {
                'da_visitare': 'üî¥ Da visitare',
                'visitato': 'üü¢ Visitato',
                'follow_up': 'üü† Follow-up necessario'
            };
            return statusMap[stato] || stato;
        }

        function getResultText(risultato) {
            const resultMap = {
                'interessato': '‚úÖ Interessato',
                'non_interessato': '‚ùå Non interessato',
                'da_ricontattare': 'üìû Da ricontattare',
                'preventivo_richiesto': 'üìã Preventivo richiesto'
            };
            return resultMap[risultato] || risultato;
        }

        function getActionText(azione) {
            const actionMap = {
                'richiamata': 'üìû Richiamata telefonica',
                'email_info': 'üìß Email informativa',
                'preventivo': 'üìã Preparare preventivo',
                'demo': 'üéØ Organizzare demo'
            };
            return actionMap[azione] || azione;
        }

        function simulateNavigation(nome, indirizzo) {
            alert(`üß≠ Navigazione verso:\n${nome}\n${indirizzo}\n\n(Questa √® una simulazione - in una vera app si aprirebbe Google Maps)`);
        }

        function openVisitModal(shopId) {
            const modal = document.getElementById('visitModal');
            const shopIdInput = document.getElementById('visitShopId');
            const dateTimeInput = document.getElementById('visitDateTime');
            
            shopIdInput.value = shopId;
            
            // Set current date and time
            const now = new Date();
            const formattedDateTime = now.toISOString().slice(0, 16);
            dateTimeInput.value = formattedDateTime;
            
            // Reset form
            document.getElementById('visitForm').reset();
            document.getElementById('visitShopId').value = shopId;
            document.getElementById('visitDateTime').value = formattedDateTime;
            document.getElementById('interestSlider').value = 5;
            document.getElementById('sliderValue').textContent = '5';
            
            modal.classList.add('active');
        }

        function closeVisitModal() {
            document.getElementById('visitModal').classList.remove('active');
        }

        function openAddShopModal() {
            const modal = document.getElementById('addShopModal');
            document.getElementById('addShopForm').reset();
            modal.classList.add('active');
        }

        function closeAddShopModal() {
            document.getElementById('addShopModal').classList.remove('active');
        }

        function setupForms() {
            // Interest slider
            const slider = document.getElementById('interestSlider');
            const sliderValue = document.getElementById('sliderValue');
            
            if (slider && sliderValue) {
                slider.addEventListener('input', function() {
                    sliderValue.textContent = this.value;
                });
            }
            
            // Visit form submission
            const visitForm = document.getElementById('visitForm');
            if (visitForm) {
                visitForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitVisit();
                });
            }
            
            // Add shop form submission
            const addShopForm = document.getElementById('addShopForm');
            if (addShopForm) {
                addShopForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    addNewShop();
                });
            }
        }

        function submitVisit() {
            const shopId = parseInt(document.getElementById('visitShopId').value);
            const dateTime = document.getElementById('visitDateTime').value;
            const interesse = parseInt(document.getElementById('interestSlider').value);
            const risultato = document.getElementById('visitResult').value;
            const commenti = document.getElementById('visitComments').value;
            const prossimaAzione = document.getElementById('nextAction').value;
            
            // Find the shop
            const negozio = negozi.find(n => n.id === shopId);
            if (!negozio) return;
            
            // Add the visit
            const visita = {
                data: dateTime,
                interesse: interesse,
                risultato: risultato,
                commenti: commenti,
                prossima_azione: prossimaAzione
            };
            
            negozio.visite.push(visita);
            negozio.interesse = interesse;
            negozio.ultimo_contatto = dateTime.split('T')[0];
            
            // Update status based on result
            if (risultato === 'non_interessato') {
                negozio.stato = 'visitato';
            } else if (risultato === 'da_ricontattare' || risultato === 'preventivo_richiesto') {
                negozio.stato = 'follow_up';
            } else {
                negozio.stato = 'visitato';
            }
            
            // Close modal and refresh displays
            closeVisitModal();
            renderShopList();
            renderMaps();
            
            alert('‚úÖ Visita registrata con successo!');
        }

        function addNewShop() {
            const nome = document.getElementById('newShopName').value;
            const indirizzo = document.getElementById('newShopAddress').value;
            const tipo = document.getElementById('newShopType').value;
            const note = document.getElementById('newShopNotes').value;
            
            // Generate new ID
            const newId = Math.max(...negozi.map(n => n.id)) + 1;
            
            // Generate random coordinates around Milano
            const lat = 45.464 + (Math.random() - 0.5) * 0.04;
            const lng = 9.190 + (Math.random() - 0.5) * 0.04;
            
            const nuovoNegozio = {
                id: newId,
                nome: nome,
                indirizzo: indirizzo,
                tipo: tipo,
                stato: 'da_visitare',
                interesse: 0,
                ultimo_contatto: '',
                lat: lat,
                lng: lng,
                visite: [],
                note: note
            };
            
            negozi.push(nuovoNegozio);
            
            // Close modal and refresh displays
            closeAddShopModal();
            applyFilters(); // This will re-render the shop list
            renderMaps();
            
            alert(`‚úÖ Negozio "${nome}" aggiunto con successo!`);
        }

        function renderStatistics() {
            // Simple chart implementation using Canvas
            renderVisitsChart();
            renderTypeChart();
        }

        function renderVisitsChart() {
            const canvas = document.getElementById('visitsChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Sample data for weekly visits
            const data = {
                labels: ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'],
                datasets: [{
                    label: 'Visite',
                    data: [2, 4, 3, 5, 4, 2, 1],
                    backgroundColor: 'rgba(30, 64, 175, 0.2)',
                    borderColor: 'rgba(30, 64, 175, 1)',
                    borderWidth: 2,
                    fill: true
                }]
            };
            
            new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderTypeChart() {
            const canvas = document.getElementById('typeChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Count shops by type
            const typeCounts = {};
            negozi.forEach(negozio => {
                typeCounts[negozio.tipo] = (typeCounts[negozio.tipo] || 0) + 1;
            });
            
            const data = {
                labels: Object.keys(typeCounts),
                datasets: [{
                    data: Object.values(typeCounts),
                    backgroundColor: [
                        '#1FB8CD',
                        '#FFC185', 
                        '#B4413C',
                        '#ECEBD5',
                        '#5D878F'
                    ]
                }]
            };
            
            new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Modal click outside to close
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });
    </script>
</body>
</html>